<div *ngIf="userData as user">

    <div *ngIf="isFromCommunity" class="back-container">
        <button mat-stroked-button (click)="goBack()">
            ‚Üê Regresar
        </button>
    </div>
    <!-- ================= CARD VISUAL (COVER + FOTO) ================= -->
    <mat-card class="profile-visual-card">

        <!-- COVER -->
        <div class="cover-wrapper" [class.clickable]="isOwner && !isVisitor"
            (click)="isOwner && !isVisitor && confirmChangeCover(coverInput)">

            <div class="cover" [style.backgroundImage]="
                 user.coverPhotoURL
                 ? 'url(' + user.coverPhotoURL + ')'
                 : 'url(/images/cover-default.jpg)'">
            </div>

            <div *ngIf="isOwner && !isVisitor" class="cover-overlay-text">
                Cambiar portada
            </div>

            <!-- SPINNER COVER -->
            <div class="cover-spinner-overlay" *ngIf="uploadingCover">
                <mat-spinner diameter="50"></mat-spinner>
            </div>

        </div>

        <input type="file" hidden #coverInput accept="image/*" (change)="onCoverSelected($event)">

        <!-- FOTO PERFIL -->
        <div class="profile-avatar-wrapper" [class.clickable]="isOwner && !isVisitor"
            (click)="isOwner && !isVisitor && confirmChangeProfilePhoto(fileInput)">

            <img class="profile-photo" [src]="user.photoURL || '/images/images.png'">

            <!-- SPINNER FOTO -->
            <div class="spinner-overlay" *ngIf="uploadingPhoto">
                <mat-spinner diameter="40"></mat-spinner>
            </div>

        </div>

        <input type="file" hidden #fileInput accept="image/*" (change)="onFileSelected($event)">

    </mat-card>


    <!-- ================= CARD INFO ================= -->
    <mat-card class="profile-info-card">

        <h2 *ngIf="isOwner">
            {{ user.name }}
            {{ user.lastNameFather }}
            {{ user.lastNameMother }}
            <!-- {{ user.uid }} -->
        </h2>
        <div *ngIf="isBirthdayToday" class="birthday-banner">
            üéâ Muchas Felicidades, ¬°Hoy es tu cumplea√±os! üéÇ
        </div>

        <!-- <p *ngIf="isOwner" class="role">
            Rol: {{ user.role }}
        </p> -->

        <p *ngIf="isOwner && user.membershipEnd">
            Membres√≠a v√°lida hasta:
            <strong>
                {{ user.membershipEnd?.toDate() | date:'longDate' }}
            </strong>
        </p>

        <p *ngIf="isOwner && user.membershipStatus">
            Estado:
            <strong>
                {{ user.membershipStatus === 'active' ? 'Activa' : 'Vencida' }}
            </strong>
        </p>
        <!-- ================= NICKNAME ================= -->

        <div class="nickname-section">

            <div *ngIf="!editingNickname">

                <h2 class="nickname">
                    {{ user.nickname || 'Sin nickname' }}
                </h2>

                <button *ngIf="isOwner && !isVisitor" mat-stroked-button (click)="editingNickname = true">
                    Editar nickname
                </button>

            </div>

            <div *ngIf="editingNickname && isOwner && !isVisitor">

                <input type="text" [(ngModel)]="newNickname" maxlength="20" placeholder="Tu nickname"
                    class="nickname-input">

                <div class="edit-actions">
                    <button mat-button (click)="editingNickname = false">
                        Cancelar
                    </button>

                    <button mat-raised-button color="primary" (click)="saveNickname()">
                        Guardar
                    </button>
                </div>

            </div>

        </div>

        <!-- ================= BIO ================= -->
        <div class="bio-section">

            <div *ngIf="!editingBio">
                <p class="bio">
                    {{ user.bio || 'Sin biograf√≠a a√∫n.' }}
                </p>

                <button mat-stroked-button *ngIf="isOwner && !isVisitor" (click)="editingBio = true">
                    Editar biograf√≠a
                </button>
            </div>

            <div *ngIf="editingBio">

                <textarea [(ngModel)]="newBio" rows="3" class="bio-input">
      </textarea>

                <div class="bio-actions">
                    <button mat-button (click)="editingBio = false">
                        Cancelar
                    </button>

                    <button mat-raised-button color="primary" (click)="saveBio()">
                        Guardar
                    </button>
                </div>

            </div>

        </div>

        <hr class="section-divider">
        <h3>Progresos</h3>
        <div class="workout-stats">
            <p>üí™ Total: <strong>{{ totalWorkouts }}</strong></p>
            <p>üìÜ Este mes: <strong>{{ monthlyWorkouts }}</strong></p>
        </div>

        <div class="weekly-chart">

            <h3>Actividad √∫ltimos 7 d√≠as</h3>

            <div class="chart-container">
                <div class="chart-bar" *ngFor="let day of weeklyStats">

                    <div class="bar" [style.height.px]="(day.count / maxWeeklyCount) * 100">
                    </div>

                    <span class="label">{{ day.label }}</span>

                </div>
            </div>

        </div>
        <hr class="section-divider">

        <div class="extra-info-section">

            <h3>Informaci√≥n adicional</h3>

            <!-- üî• MODO VISUAL -->
            <div *ngIf="!editingExtraInfo">

                <p>
                    <strong>G√©nero:</strong>
                    {{ user.gender || 'No especificado' }}
                </p>
                <p *ngIf="isOwner && user.birthDate">
                    <strong>Fecha de nacimiento:</strong>
                    {{ user.birthDate?.toDate() | date:'longDate' }}
                </p>

                <div *ngIf="isOwner">

                    <p>
                        <strong>Contacto de emergencia:</strong>
                        {{ user.emergencyContact?.name || 'No definido' }}
                    </p>

                    <p>
                        <strong>Tel√©fono emergencia:</strong>
                        {{ user.emergencyContact?.phone || 'No definido' }}
                    </p>

                </div>

                <button *ngIf="isOwner && !isVisitor" mat-stroked-button (click)="editingExtraInfo = true">
                    Editar informaci√≥n
                </button>

            </div>

            <!-- üî• MODO EDICI√ìN -->
            <div *ngIf="editingExtraInfo">

                <!-- G√âNERO -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>G√©nero</mat-label>
                    <mat-select [(ngModel)]="selectedGender">
                        <mat-option value="Masculino">Masculino</mat-option>
                        <mat-option value="Femenino">Femenino</mat-option>
                        <mat-option value="Otro">Otro</mat-option>
                    </mat-select>
                </mat-form-field>
                <!-- CUMPLEA√ëOS -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Cumplea√±os</mat-label>
                    <input matInput type="date" [(ngModel)]="birthDate">
                </mat-form-field>

                <!-- CONTACTO EMERGENCIA -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Nombre contacto emergencia</mat-label>
                    <input matInput [(ngModel)]="emergencyName">
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Tel√©fono emergencia</mat-label>
                    <input matInput [(ngModel)]="emergencyPhone" maxlength="10" inputmode="numeric"
                        (input)="validateEmergencyPhone()">
                    <mat-error *ngIf="emergencyPhoneError">
                        El tel√©fono debe tener exactamente 10 n√∫meros
                    </mat-error>
                </mat-form-field>


                <div class="edit-actions">
                    <button mat-button (click)="editingExtraInfo = false">
                        Cancelar
                    </button>

                    <button mat-raised-button color="primary" (click)="saveExtraInfo()"
                        [disabled]="emergencyPhoneError">
                        Guardar
                    </button>
                </div>

            </div>

        </div>
        <hr class="section-divider">

        <!-- ================= BOTON VISIBILIDAD PUBLICO/PRIVADO ================= -->


        <div class="profile-visibility">
            <button *ngIf="isOwner && !isVisitor" mat-raised-button [color]="user.isPublic ? 'primary' : 'warn'"
                (click)="togglePublicProfile()">

                <mat-icon>
                    {{ user.isPublic ? 'public' : 'lock' }}
                </mat-icon>

                {{ user.isPublic ? 'Perfil P√∫blico' : 'Perfil Privado' }}

            </button>
        </div>

    </mat-card>

    <!-- GALERIA -->
    <mat-card class="gallery-card">

        <div class="gallery-header">
            <h3>Mi Galer√≠a</h3>

            <button *ngIf="isOwner && !isVisitor" mat-stroked-button (click)="openGalleryInput()">
                + Agregar
            </button>
        </div>

        <input *ngIf="isOwner" type="file" hidden #galleryInput accept="image/*" (change)="onGallerySelected($event)">

        <div class="gallery-grid">
            <div class="gallery-item" *ngFor="let photo of gallery">

                <!-- üñº IMAGEN -->
                <div class="image-wrapper">

                    <img [src]="photo.imageUrl" (click)="openGalleryPreview(photo.imageUrl)"
                        (load)="photo.loaded = true" [class.loaded]="photo.loaded">

                    <button *ngIf="isOwner" class="delete-btn" (click)="deletePhoto(photo, $event)">
                        ‚úï
                    </button>

                    <button *ngIf="isOwner" class="replace-btn" (click)="selectPhotoToReplace(photo, $event)">
                        üîÑ
                    </button>

                </div>

                <!-- üì¶ CONTENEDOR INFO -->
                <div class="photo-info">

                    <!-- ‚ù§Ô∏è LIKE -->
                    <div class="photo-actions">
                        <button mat-icon-button (click)="toggleLike(photo)" [color]="hasLiked(photo) ? 'warn' : ''">
                            <mat-icon>
                                {{ hasLiked(photo) ? 'favorite' : 'favorite_border' }}
                            </mat-icon>
                        </button>
                        <span>{{ photo.likes?.length || 0 }}</span>
                    </div>

                    <!-- üí¨ COMMENTS -->
                    <div class="comments-section">

                        <div class="comment" *ngFor="let comment of (photo.comments || []) | slice:-3">

                            <strong>{{ comment.name }}</strong>
                            <span> - {{ comment.text }}</span>

                            <!-- üî• BOT√ìN BORRAR -->
                            <button *ngIf="isOwner || comment.uid === currentUserId" mat-icon-button
                                (click)="deleteComment(photo, comment.id)">
                                <mat-icon>delete</mat-icon>
                            </button>

                        </div>

                        <div class="comment-input">

                            <input type="text" maxlength="100" placeholder="Escribe un comentario..."
                                [(ngModel)]="newCommentText[photo.id]" (keyup.enter)="addComment(photo)">
                            <small class="char-counter">
                                {{ (newCommentText[photo.id]?.length || 0) }}/100
                            </small>

                            <button mat-raised-button color="primary" (click)="addComment(photo)">
                                Enviar
                            </button>

                        </div>

                    </div>

                </div>

            </div>
        </div>

        <div *ngIf="uploadingGallery">
            <mat-spinner diameter="40"></mat-spinner>
        </div>

    </mat-card>

</div>