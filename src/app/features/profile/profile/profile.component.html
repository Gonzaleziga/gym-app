<div *ngIf="userData as user">

    <div *ngIf="isFromCommunity" class="back-container">
        <button mat-stroked-button (click)="goBack()">
            ‚Üê Regresar
        </button>
    </div>
    <!-- ================= CARD VISUAL (COVER + FOTO) ================= -->
    <mat-card class="profile-visual-card">

        <!-- COVER -->
        <div class="cover-wrapper" [class.clickable]="isOwner" (click)="isOwner && confirmChangeCover(coverInput)">

            <div class="cover" [style.backgroundImage]="
                 user.coverPhotoURL
                 ? 'url(' + user.coverPhotoURL + ')'
                 : 'url(/images/cover-default.jpg)'">
            </div>

            <div *ngIf="isOwner" class="cover-overlay-text">
                Cambiar portada
            </div>

            <!-- SPINNER COVER -->
            <div class="cover-spinner-overlay" *ngIf="uploadingCover">
                <mat-spinner diameter="50"></mat-spinner>
            </div>

        </div>

        <input type="file" hidden #coverInput accept="image/*" (change)="onCoverSelected($event)">

        <!-- FOTO PERFIL -->
        <div class="profile-avatar-wrapper" [class.clickable]="isOwner"
            (click)="isOwner && confirmChangeProfilePhoto(fileInput)">

            <img class="profile-photo" [src]="user.photoURL || '/images/images.png'">

            <!-- SPINNER FOTO -->
            <div class="spinner-overlay" *ngIf="uploadingPhoto">
                <mat-spinner diameter="40"></mat-spinner>
            </div>

        </div>

        <input type="file" hidden #fileInput accept="image/*" (change)="onFileSelected($event)">

    </mat-card>


    <!-- ================= CARD INFO ================= -->
    <mat-card class="profile-info-card">

        <h2>
            {{ user.name }}
            {{ user.lastNameFather }}
            {{ user.lastNameMother }}
        </h2>

        <p *ngIf="isOwner" class="role">
            Rol: {{ user.role }}
        </p>

        <p *ngIf="isOwner && user.membershipEnd">
            Membres√≠a v√°lida hasta:
            <strong>
                {{ user.membershipEnd?.toDate() | date:'longDate' }}
            </strong>
        </p>

        <p *ngIf="isOwner && user.membershipStatus">
            Estado:
            <strong>
                {{ user.membershipStatus === 'active' ? 'Activa' : 'Vencida' }}
            </strong>
        </p>

        <!-- ================= BIO ================= -->
        <div class="bio-section">

            <div *ngIf="!editingBio">
                <p class="bio">
                    {{ user.bio || 'Sin biograf√≠a a√∫n.' }}
                </p>

                <button mat-stroked-button *ngIf="isOwner" (click)="editingBio = true">
                    Editar biograf√≠a
                </button>
            </div>

            <div *ngIf="editingBio">

                <textarea [(ngModel)]="newBio" rows="3" class="bio-input">
      </textarea>

                <div class="bio-actions">
                    <button mat-button (click)="editingBio = false">
                        Cancelar
                    </button>

                    <button mat-raised-button color="primary" (click)="saveBio()">
                        Guardar
                    </button>
                </div>

            </div>

        </div>



        <hr class="section-divider">

        <div class="extra-info-section">

            <h3>Informaci√≥n adicional</h3>

            <!-- üî• MODO VISUAL -->
            <div *ngIf="!editingExtraInfo">

                <p>
                    <strong>G√©nero:</strong>
                    {{ user.gender || 'No especificado' }}
                </p>

                <div *ngIf="isOwner">

                    <p>
                        <strong>Contacto de emergencia:</strong>
                        {{ user.emergencyContact?.name || 'No definido' }}
                    </p>

                    <p>
                        <strong>Tel√©fono emergencia:</strong>
                        {{ user.emergencyContact?.phone || 'No definido' }}
                    </p>

                </div>

                <button *ngIf="isOwner" mat-stroked-button (click)="editingExtraInfo = true">
                    Editar informaci√≥n
                </button>

            </div>

            <!-- üî• MODO EDICI√ìN -->
            <div *ngIf="editingExtraInfo">

                <!-- G√âNERO -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>G√©nero</mat-label>
                    <mat-select [(ngModel)]="selectedGender">
                        <mat-option value="Masculino">Masculino</mat-option>
                        <mat-option value="Femenino">Femenino</mat-option>
                        <mat-option value="Otro">Otro</mat-option>
                    </mat-select>
                </mat-form-field>

                <!-- CONTACTO EMERGENCIA -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Nombre contacto emergencia</mat-label>
                    <input matInput [(ngModel)]="emergencyName">
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Tel√©fono emergencia</mat-label>
                    <input matInput [(ngModel)]="emergencyPhone">
                </mat-form-field>

                <div class="edit-actions">
                    <button mat-button (click)="editingExtraInfo = false">
                        Cancelar
                    </button>

                    <button mat-raised-button color="primary" (click)="saveExtraInfo()">
                        Guardar
                    </button>
                </div>

            </div>

        </div>
        <hr class="section-divider">
        <!-- ================= VISIBILIDAD ================= -->


        <div class="profile-visibility">
            <button *ngIf="isOwner" mat-raised-button [color]="user.isPublic ? 'primary' : 'warn'"
                (click)="togglePublicProfile()">

                <mat-icon>
                    {{ user.isPublic ? 'public' : 'lock' }}
                </mat-icon>

                {{ user.isPublic ? 'Perfil P√∫blico' : 'Perfil Privado' }}

            </button>
        </div>

    </mat-card>

    <mat-card class="gallery-card">

        <div class="gallery-header">
            <h3>Mi Galer√≠a</h3>

            <button *ngIf="isOwner" mat-stroked-button (click)="openGalleryInput()">
                + Agregar
            </button>
        </div>

        <input *ngIf="isOwner" type="file" hidden #galleryInput accept="image/*" (change)="onGallerySelected($event)">

        <div class="gallery-grid">

            <div class="gallery-item" *ngFor="let photo of gallery">

                <!-- Imagen -->
                <img [src]="photo.imageUrl" (click)="openGalleryPreview(photo.imageUrl)" (load)="photo.loaded = true"
                    [class.loaded]="photo.loaded">

                <!-- Bot√≥n eliminar -->
                <button *ngIf="isOwner" class="delete-btn" (click)="deletePhoto(photo, $event)">
                    ‚úï
                </button>

                <!-- Bot√≥n reemplazar -->
                <button *ngIf="isOwner" class="replace-btn" (click)="selectPhotoToReplace(photo, $event)">
                    üîÑ
                </button>

            </div>

        </div>

        <div *ngIf="uploadingGallery">
            <mat-spinner diameter="40"></mat-spinner>
        </div>

    </mat-card>

</div>