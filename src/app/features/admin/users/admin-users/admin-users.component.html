<div *ngIf="loading">
    <p>Cargando usuarios...</p>
</div>
<!-- ðŸ” BUSCADOR GENERAL -->
<div class="search-bar">
    <input type="text" placeholder="ðŸ” Buscar por nombre o email..." [(ngModel)]="searchTerm" />
</div>
<mat-tab-group *ngIf="!loading" [(selectedIndex)]="activeTabIndex">

    <!-- ================= ADMIN ================= -->
    <mat-tab label="Administradores">

        <mat-card *ngFor="let user of getFilteredUsers(admins)" class="client-card">

            <div class="card-header">

                <img class="avatar" [src]="user.photoURL || '/images/images.png'">

                <div class="basic-info">
                    <h3>{{ user.name }} {{ user.lastNameFather }} {{ user.lastNameMother }}</h3>
                    <p>{{ user.email }}</p>

                    <span class="account-status" [ngClass]="{
                  'status-active': user.status === 'active',
                  'status-inactive': user.status === 'inactive'
                }">
                        {{ user.status === 'active' ? 'Cuenta Activa' : 'Cuenta Bloqueada' }}
                    </span>
                </div>

                <button mat-stroked-button color="primary" (click)="toggleDetails(user.uid)">
                    {{ expandedUserId === user.uid ? 'Ocultar' : 'Detalles' }}
                </button>

            </div>

            <div class="details-panel" *ngIf="expandedUserId === user.uid">

                <hr>

                <div class="admin-actions">

                    <button mat-stroked-button color="warn" (click)="toggleStatus(user)">
                        Bloquear cuenta
                    </button>

                    <button mat-stroked-button color="accent" (click)="forceLogout(user.uid)">
                        Forzar logout
                    </button>

                    <button mat-stroked-button (click)="resetPassword(user)">
                        Reset password
                    </button>

                </div>

                <div class="roles-section">
                    <strong>Cambiar rol:</strong>

                    <button mat-stroked-button *ngFor="let r of roles" (click)="changeRole(user.uid, r)"
                        [disabled]="user.role === r">
                        {{ r }}
                    </button>
                </div>

            </div>

        </mat-card>

    </mat-tab>

    <!-- ================= EMPLEADOS ================= -->
    <mat-tab label="Empleados">

        <mat-card *ngFor="let user of getFilteredUsers(employees)" class="client-card">

            <div class="card-header">

                <img class="avatar" [src]="user.photoURL || '/images/images.png'">

                <div class="basic-info">
                    <h3>{{ user.name }} {{ user.lastNameFather }} {{ user.lastNameMother }}</h3>
                    <p>{{ user.email }}</p>

                    <span class="account-status" [ngClass]="{
                      'status-active': user.status === 'active',
                      'status-inactive': user.status === 'inactive'
                    }">
                        {{ user.status === 'active' ? 'Cuenta Activa' : 'Cuenta Bloqueada' }}
                    </span>
                </div>

                <button mat-stroked-button color="primary" (click)="toggleDetails(user.uid)">
                    {{ expandedUserId === user.uid ? 'Ocultar' : 'Detalles' }}
                </button>

            </div>

            <div class="details-panel" *ngIf="expandedUserId === user.uid">

                <hr>

                <div class="admin-actions">

                    <button mat-stroked-button color="warn" (click)="toggleStatus(user)">
                        Bloquear cuenta
                    </button>

                    <button mat-stroked-button color="accent" (click)="forceLogout(user.uid)">
                        Forzar logout
                    </button>

                    <button mat-stroked-button (click)="resetPassword(user)">
                        Reset password
                    </button>

                </div>

                <div class="roles-section">
                    <strong>Cambiar rol:</strong>

                    <button mat-stroked-button *ngFor="let r of roles" (click)="changeRole(user.uid, r)"
                        [disabled]="user.role === r">
                        {{ r }}
                    </button>
                </div>

            </div>

        </mat-card>

    </mat-tab>

    <!-- ================= CARD CLIENTES  ================= -->
    <mat-tab label="Clientes">

        <mat-card *ngFor="let user of getFilteredUsers(clients)" class="client-card">

            <!-- HEADER -->
            <div class="card-header aligned-top">

                <!-- FOTO -->
                <!-- FOTO -->
                <div class="avatar-wrapper" (click)="confirmChangeAdminPhoto(user, fileInput)">

                    <img class="avatar-top" [src]="user.adminPhotoURL || user.photoURL || '/images/images.png'">

                    <div class="spinner-overlay" *ngIf="uploadingPhotoUserId === user.uid">

                        <mat-spinner diameter="40"></mat-spinner>

                    </div>

                </div>

                <!-- INPUT OCULTO -->
                <input type="file" #fileInput hidden accept="image/*" (change)="uploadAdminPhoto(user, $event)">
                <!-- INFORMACIÃ“N -->
                <div class="basic-info">

                    <h3>
                        {{ user.name }} {{ user.lastNameFather }} {{ user.lastNameMother }}
                    </h3>
                    <div class="compact-row">
                        <span *ngIf="user.email">{{ user.email }}</span>
                    </div>
                    <div class="compact-row">

                        <span *ngIf="user.phone">ðŸ“ž {{ user.phone }}</span>

                        <span *ngIf="user.membershipStart">
                            Inicio:
                            {{ user.membershipStart?.toDate() | date:'mediumDate' }}
                        </span>

                        <span *ngIf="user.membershipEnd">
                            Vence:
                            {{ user.membershipEnd?.toDate() | date:'mediumDate' }}
                        </span>
                    </div>

                    <div class="compact-row">
                        <span *ngIf="user.planId">
                            Plan: {{ getPlanName(user.planId) }}
                        </span>

                        <span *ngIf="user.lastPaymentAmount">
                            Ãšltimo pago: ${{ user.lastPaymentAmount }}
                        </span>
                    </div>

                    <div class="compact-row">
                        <span *ngIf="user.gender">
                            GÃ©nero: {{ user.gender }}
                        </span>

                        <span *ngIf="user.emergencyContact?.name || user.emergencyContact?.phone">
                            Emergencia:
                            {{ user.emergencyContact?.name }}
                            <span *ngIf="user.emergencyContact?.phone">
                                ({{ user.emergencyContact?.phone }})
                            </span>
                        </span>
                    </div>

                    <!-- ESTADOS -->
                    <div class="status-row">
                        <span class="account-status" [ngClass]="{
                                'account-active': user.status === 'active',
                                'account-blocked': user.status === 'inactive'
                              }">
                            {{ user.status === 'active'
                            ? 'Cuenta Activa'
                            : 'Cuenta Bloqueada' }}
                        </span>

                        <span class="membership-status" [ngClass]="{
                                'membership-active': user.membershipStatus === 'active',
                                'membership-expired': user.membershipStatus === 'expired',
                                'membership-none': user.membershipStatus === 'none'
                              }">
                            {{
                            user.membershipStatus === 'active' ? 'MembresÃ­a Activa':
                            user.membershipStatus === 'expired'? 'MembresÃ­a Vencida':
                            'Sin MembresÃ­a'
                            }}
                        </span>
                    </div>

                </div>

                <!-- BOTÃ“N DETALLES -->
                <button mat-stroked-button color="primary" (click)="toggleDetails(user.uid)">
                    {{ expandedUserId === user.uid ? 'Ocultar' : 'Detalles' }}
                </button>

            </div>

            <!-- PANEL EXPANDIDO -->
            <div class="details-panel" *ngIf="expandedUserId === user.uid">
                <hr>

                <!-- ================= SECCIÃ“N FINANCIERA ================= -->
                <div class="section-card">

                    <h4 class="section-title">ðŸ’³ GestiÃ³n Financiera</h4>

                    <div class="section-row">
                        <mat-form-field appearance="outline" class="section-field">
                            <mat-label>Seleccionar Plan</mat-label>
                            <mat-select [(ngModel)]="user.selectedPlan">
                                <mat-option *ngFor="let plan of plans" [value]="plan.id">
                                    {{ plan.name }} - ${{ plan.price }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <button mat-raised-button color="primary" class="section-btn" (click)="assignPlan(user)"
                            [disabled]="user.planId">

                            {{ user.planId ? 'Plan Asignado' : 'Asignar Plan' }}

                        </button>
                    </div>

                    <div class="section-row">
                        <button mat-stroked-button color="primary" (click)="viewPayments(user)"
                            [disabled]="!user.lastPaymentAmount">

                            ðŸ“œ Historial

                        </button>

                        <button mat-raised-button color="accent" (click)="registerPayment(user)"
                            [disabled]="!user.planId">

                            Registrar Pago

                        </button>
                    </div>

                </div>


                <!-- ================= SECCIÃ“N RUTINA ================= -->
                <div class="section-card">

                    <h4 class="section-title">ðŸ’ª GestiÃ³n de Rutina</h4>

                    <div class="section-row">

                        <mat-form-field appearance="outline" class="section-field">
                            <mat-label>Seleccionar Rutina</mat-label>
                            <mat-select [(ngModel)]="user.selectedRoutine">
                                <mat-option *ngFor="let routine of routines" [value]="routine.id">
                                    {{ routine.name }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <button mat-raised-button color="primary" (click)="assignRoutine(user)">

                            {{ user.assignedRoutineId ? 'Cambiar Rutina' : 'Asignar Rutina' }}

                        </button>


                    </div>

                </div>


                <!-- ================= SECCIÃ“N ADMIN ================= -->
                <div class="section-card">

                    <h4 class="section-title">âš™ AdministraciÃ³n</h4>

                    <div class="admin-actions">
                        <button mat-stroked-button color="warn" (click)="toggleStatus(user)">
                            Bloquear cuenta
                        </button>

                        <button mat-stroked-button color="accent" (click)="forceLogout(user.uid)">
                            Forzar logout
                        </button>

                        <button mat-stroked-button (click)="resetPassword(user)">
                            Reset password
                        </button>
                    </div>

                    <div class="roles-section">
                        <!-- <strong>Cambiar rol:</strong> -->
                        <button mat-stroked-button *ngFor="let r of roles" (click)="changeRole(user.uid, r)"
                            [disabled]="user.role === r">
                            {{ r }}
                        </button>
                    </div>

                </div>

            </div>
        </mat-card>
    </mat-tab>


    <!-- ================= VISITANTES ================= -->

    <mat-tab label="Visitantes">
        <mat-card *ngFor="let user of getFilteredUsers(visitors)" class="client-card">
            <div class="card-header">
                <img class="avatar" [src]="user.photoURL || '/images/images.png'">
                <div class="basic-info">
                    <h3>{{ user.name }} {{ user.lastNameFather }} {{ user.lastNameMother }}</h3>
                    <p>{{ user.email }}</p>
                    <span class="account-status" [ngClass]="{
                      'status-active': user.status === 'active',
                      'status-inactive': user.status === 'inactive'
                    }">
                        {{ user.status === 'active' ? 'Cuenta Activa' : 'Cuenta Bloqueada' }}
                    </span>
                </div>
                <button mat-stroked-button color="primary" (click)="toggleDetails(user.uid)">
                    {{ expandedUserId === user.uid ? 'Ocultar' : 'Detalles' }}
                </button>
            </div>
            <div class="details-panel" *ngIf="expandedUserId === user.uid">
                <hr>
                <div class="admin-actions">
                    <button mat-stroked-button color="warn" (click)="toggleStatus(user)">
                        Bloquear cuenta
                    </button>
                    <button mat-stroked-button color="accent" (click)="forceLogout(user.uid)">
                        Forzar logout
                    </button>
                    <button mat-stroked-button (click)="resetPassword(user)">
                        Reset password
                    </button>
                </div>

                <div class="roles-section">
                    <strong>Cambiar rol:</strong>
                    <button mat-stroked-button *ngFor="let r of roles" (click)="changeRole(user.uid, r)"
                        [disabled]="user.role === r">
                        {{ r }}
                    </button>
                </div>
            </div>
        </mat-card>
    </mat-tab>
</mat-tab-group>