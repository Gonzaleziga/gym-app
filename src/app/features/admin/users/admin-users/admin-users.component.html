<div *ngIf="loading">
    <p>Cargando usuarios...</p>
</div>
<!-- üîç BUSCADOR GENERAL -->
<div class="search-bar">
    <input type="text" placeholder="üîç Buscar por nombre o email..." [(ngModel)]="searchTerm" />
</div>
<mat-tab-group [(selectedIndex)]="activeTabIndex" (selectedTabChange)="onTabChange($event)">

    <!-- ================= ADMIN ================= -->
    <mat-tab label="Administradores">

        <mat-card *ngFor="let user of getFilteredUsers(admins)" class="client-card">


            <!-- HEADER -->
            <div class="card-header aligned-top">


                <!-- FOTO -->
                <div class="avatar-wrapper" (click)="confirmChangeAdminPhoto(user, fileInput)">

                    <div class="avatar-wrapper">

                        <!-- FOTO ADMIN (principal) -->
                        <img class="avatar-admin" [src]="user.adminPhotoURL || '/images/images.png'">

                        <!-- MINI FOTO PERFIL USUARIO -->
                        <img *ngIf="user.photoURL" class="avatar-user-mini" [src]="user.photoURL">

                        <!-- SPINNER -->
                        <div class="spinner-overlay" *ngIf="uploadingPhotoUserId === user.uid">
                            <mat-spinner diameter="35"></mat-spinner>
                        </div>

                    </div>

                    <div class="spinner-overlay" *ngIf="uploadingPhotoUserId === user.uid">

                        <mat-spinner diameter="40"></mat-spinner>

                    </div>

                </div>

                <!-- INPUT OCULTO -->
                <input type="file" #fileInput hidden accept="image/*" (change)="uploadAdminPhoto(user, $event)">
                <!-- INFORMACI√ìN -->
                <div class="basic-info">

                    <h3>
                        {{ user.name }} {{ user.lastNameFather }} {{ user.lastNameMother }}
                    </h3>
                    <div class="compact-row">
                        <span *ngIf="user.email"> ‚úâÔ∏è {{ user.email }}</span>
                        <span *ngIf="user.phoneNumber">üìû {{ user.phoneNumber }}</span>
                    </div>
                    <div class="compact-row">

                        <span *ngIf="user.membershipStart">
                            Inicio:
                            {{ user.membershipStart?.toDate() | date:'mediumDate' }}
                        </span>

                        <span *ngIf="user.membershipEnd">
                            Vence:
                            {{ user.membershipEnd?.toDate() | date:'mediumDate' }}
                        </span>
                    </div>

                    <div class="compact-row">
                        <span *ngIf="user.planId">
                            Plan: {{ getPlanName(user.planId) }}
                        </span>

                        <span *ngIf="user.lastPaymentAmount">
                            √öltimo pago: ${{ user.lastPaymentAmount }}
                        </span>
                    </div>

                    <div class="compact-row">
                        <span *ngIf="user.gender">
                            G√©nero: {{ user.gender }}
                        </span>

                        <span *ngIf="user.emergencyContact?.name || user.emergencyContact?.phone">
                            Emergencia:
                            {{ user.emergencyContact?.name }}
                            <span *ngIf="user.emergencyContact?.phone">
                                ({{ user.emergencyContact?.phone }})
                            </span>
                        </span>

                        <span *ngIf="user.gender">
                            cumplea√±os: {{ user.gender }}
                        </span>
                    </div>

                    <!-- ESTADOS -->
                    <div class="status-row">
                        <span class="account-status" [ngClass]="{
                                'account-active': user.status === 'active',
                                'account-blocked': user.status === 'inactive'
                              }">
                            {{ user.status === 'active'
                            ? 'Cuenta Activa'
                            : 'Cuenta Bloqueada' }}
                        </span>

                        <span class="membership-status" [ngClass]="{
                                'membership-active': user.membershipStatus === 'active',
                                'membership-expired': user.membershipStatus === 'expired',
                                'membership-none': user.membershipStatus === 'none'
                              }">
                            {{
                            user.membershipStatus === 'active' ? 'Membres√≠a Activa':
                            user.membershipStatus === 'expired'? 'Membres√≠a Vencida':
                            'Sin Membres√≠a'
                            }}
                        </span>
                    </div>

                </div>

                <!-- BOT√ìN DETALLES -->
                <button mat-stroked-button color="primary" (click)="toggleDetails(user.uid)">
                    {{ expandedUserId === user.uid ? 'Ocultar' : 'Detalles' }}
                </button>

            </div>

            <!-- PANEL EXPANDIDO -->
            <div class="details-panel" *ngIf="expandedUserId === user.uid">
                <hr>

                <!-- ================= SECCI√ìN FINANCIERA ================= -->
                <div class="section-card">

                    <h4 class="section-title">üí≥ Gesti√≥n Financiera</h4>

                    <div class="section-row">
                        <mat-form-field appearance="outline" class="section-field">
                            <mat-label>Seleccionar Plan</mat-label>
                            <mat-select [(ngModel)]="user.selectedPlan">
                                <mat-option *ngFor="let plan of plans" [value]="plan.id">
                                    {{ plan.name }} - ${{ plan.price }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <button mat-raised-button color="primary" class="section-btn" (click)="assignPlan(user)"
                            [disabled]="!user.selectedPlan">

                            {{
                            user.membershipStatus === 'active'
                            ? 'Cambiar Plan'
                            : user.planId
                            ? 'Renovar Plan'
                            : 'Asignar Plan'
                            }}

                        </button>
                    </div>

                    <div class="section-row">
                        <button mat-stroked-button color="primary" (click)="viewPayments(user)" [disabled]="false">

                            üìú Historial

                        </button>

                        <button mat-raised-button color="accent" (click)="registerPayment(user)"
                            [disabled]="!user.planId">

                            Registrar Pago

                        </button>
                    </div>

                </div>


                <!-- ================= SECCI√ìN RUTINA ================= -->
                <div class="section-card">

                    <h4 class="section-title">üí™ Gesti√≥n de Rutina</h4>

                    <div class="section-row">

                        <mat-form-field appearance="outline" class="section-field">
                            <mat-label>Seleccionar Rutina</mat-label>
                            <mat-select [(ngModel)]="user.selectedRoutine">
                                <mat-option *ngFor="let routine of routines" [value]="routine.id">
                                    {{ routine.name }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <button mat-raised-button color="primary" (click)="assignRoutine(user)">

                            {{ user.assignedRoutineId ? 'Cambiar Rutina' : 'Asignar Rutina' }}

                        </button>


                    </div>

                </div>


                <!-- ================= SECCI√ìN ADMIN ================= -->
                <div class="section-card">

                    <h4 class="section-title">‚öô Administraci√≥n</h4>

                    <div class="admin-actions">
                        <button mat-stroked-button [color]="user.status === 'inactive' ? 'primary' : 'warn'"
                            (click)="toggleStatus(user)">

                            <mat-icon>
                                {{ user.status === 'inactive' ? 'lock_open' : 'lock' }}
                            </mat-icon>

                            {{ user.status === 'inactive'
                            ? 'Desbloquear cuenta'
                            : 'Bloquear cuenta' }}

                        </button>

                        <button mat-stroked-button color="accent" (click)="forceLogout(user.uid)">
                            Forzar logout
                        </button>

                        <button mat-stroked-button (click)="resetPassword(user)">
                            Reset password
                        </button>
                    </div>

                    <div class="roles-section">
                        <!-- <strong>Cambiar rol:</strong> -->
                        <button mat-stroked-button *ngFor="let r of roles" (click)="changeRole(user.uid, r)"
                            [disabled]="user.role === r">
                            {{ r }}
                        </button>
                    </div>

                </div>

            </div>
        </mat-card>
    </mat-tab>

    <!-- ================= EMPLEADOS ================= -->
    <mat-tab label="Empleados">

        <mat-card *ngFor="let user of getFilteredUsers(employees)" class="client-card">

            <!-- HEADER -->
            <div class="card-header aligned-top">


                <!-- FOTO -->
                <div class="avatar-wrapper" (click)="confirmChangeAdminPhoto(user, fileInput)">

                    <div class="avatar-wrapper">

                        <!-- FOTO ADMIN (principal) -->
                        <img class="avatar-admin" [src]="user.adminPhotoURL || '/images/images.png'">

                        <!-- MINI FOTO PERFIL USUARIO -->
                        <img *ngIf="user.photoURL" class="avatar-user-mini" [src]="user.photoURL">

                        <!-- SPINNER -->
                        <div class="spinner-overlay" *ngIf="uploadingPhotoUserId === user.uid">
                            <mat-spinner diameter="35"></mat-spinner>
                        </div>

                    </div>

                    <div class="spinner-overlay" *ngIf="uploadingPhotoUserId === user.uid">

                        <mat-spinner diameter="40"></mat-spinner>

                    </div>

                </div>

                <!-- INPUT OCULTO -->
                <input type="file" #fileInput hidden accept="image/*" (change)="uploadAdminPhoto(user, $event)">
                <!-- INFORMACI√ìN -->
                <div class="basic-info">

                    <h3>
                        {{ user.name }} {{ user.lastNameFather }} {{ user.lastNameMother }}
                    </h3>
                    <div class="compact-row">
                        <span *ngIf="user.email"> ‚úâÔ∏è {{ user.email }}</span>
                        <span *ngIf="user.phoneNumber">üìû {{ user.phoneNumber }}</span>
                    </div>
                    <div class="compact-row">
                        <span *ngIf="user.membershipStart">
                            Inicio:
                            {{ user.membershipStart?.toDate() | date:'mediumDate' }}
                        </span>

                        <span *ngIf="user.membershipEnd">
                            Vence:
                            {{ user.membershipEnd?.toDate() | date:'mediumDate' }}
                        </span>
                    </div>

                    <div class="compact-row">
                        <span *ngIf="user.planId">
                            Plan: {{ getPlanName(user.planId) }}
                        </span>

                        <span *ngIf="user.lastPaymentAmount">
                            √öltimo pago: ${{ user.lastPaymentAmount }}
                        </span>
                    </div>

                    <div class="compact-row">
                        <span *ngIf="user.gender">
                            G√©nero: {{ user.gender }}
                        </span>

                        <span *ngIf="user.emergencyContact?.name || user.emergencyContact?.phone">
                            Emergencia:
                            {{ user.emergencyContact?.name }}
                            <span *ngIf="user.emergencyContact?.phone">
                                ({{ user.emergencyContact?.phone }})
                            </span>
                        </span>
                    </div>

                    <!-- ESTADOS -->
                    <div class="status-row">
                        <span class="account-status" [ngClass]="{
                                'account-active': user.status === 'active',
                                'account-blocked': user.status === 'inactive'
                              }">
                            {{ user.status === 'active'
                            ? 'Cuenta Activa'
                            : 'Cuenta Bloqueada' }}
                        </span>

                        <span class="membership-status" [ngClass]="{
                                'membership-active': user.membershipStatus === 'active',
                                'membership-expired': user.membershipStatus === 'expired',
                                'membership-none': user.membershipStatus === 'none'
                              }">
                            {{
                            user.membershipStatus === 'active' ? 'Membres√≠a Activa':
                            user.membershipStatus === 'expired'? 'Membres√≠a Vencida':
                            'Sin Membres√≠a'
                            }}
                        </span>
                    </div>

                </div>

                <!-- BOT√ìN DETALLES -->
                <button mat-stroked-button color="primary" (click)="toggleDetails(user.uid)">
                    {{ expandedUserId === user.uid ? 'Ocultar' : 'Detalles' }}
                </button>

            </div>

            <!-- PANEL EXPANDIDO -->
            <div class="details-panel" *ngIf="expandedUserId === user.uid">
                <hr>

                <!-- ================= SECCI√ìN FINANCIERA ================= -->
                <div class="section-card">

                    <h4 class="section-title">üí≥ Gesti√≥n Financiera</h4>

                    <div class="section-row">
                        <mat-form-field appearance="outline" class="section-field">
                            <mat-label>Seleccionar Plan</mat-label>
                            <mat-select [(ngModel)]="user.selectedPlan">
                                <mat-option *ngFor="let plan of plans" [value]="plan.id">
                                    {{ plan.name }} - ${{ plan.price }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <button mat-raised-button color="primary" class="section-btn" (click)="assignPlan(user)"
                            [disabled]="!user.selectedPlan">

                            {{
                            user.membershipStatus === 'active'
                            ? 'Cambiar Plan'
                            : user.planId
                            ? 'Renovar Plan'
                            : 'Asignar Plan'
                            }}

                        </button>
                    </div>

                    <div class="section-row">
                        <button mat-stroked-button color="primary" (click)="viewPayments(user)" [disabled]="false">

                            üìú Historial

                        </button>

                        <button mat-raised-button color="accent" (click)="registerPayment(user)"
                            [disabled]="!user.planId">

                            Registrar Pago

                        </button>
                    </div>

                </div>


                <!-- ================= SECCI√ìN RUTINA ================= -->
                <div class="section-card">

                    <h4 class="section-title">üí™ Gesti√≥n de Rutina</h4>

                    <div class="section-row">

                        <mat-form-field appearance="outline" class="section-field">
                            <mat-label>Seleccionar Rutina</mat-label>
                            <mat-select [(ngModel)]="user.selectedRoutine">
                                <mat-option *ngFor="let routine of routines" [value]="routine.id">
                                    {{ routine.name }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <button mat-raised-button color="primary" (click)="assignRoutine(user)">

                            {{ user.assignedRoutineId ? 'Cambiar Rutina' : 'Asignar Rutina' }}

                        </button>


                    </div>

                </div>


                <!-- ================= SECCI√ìN ADMIN ================= -->
                <div class="section-card">

                    <h4 class="section-title">‚öô Administraci√≥n</h4>

                    <div class="admin-actions">
                        <button mat-stroked-button [color]="user.status === 'inactive' ? 'primary' : 'warn'"
                            (click)="toggleStatus(user)">

                            <mat-icon>
                                {{ user.status === 'inactive' ? 'lock_open' : 'lock' }}
                            </mat-icon>

                            {{ user.status === 'inactive'
                            ? 'Desbloquear cuenta'
                            : 'Bloquear cuenta' }}

                        </button>

                        <button mat-stroked-button color="accent" (click)="forceLogout(user.uid)">
                            Forzar logout
                        </button>

                        <button mat-stroked-button (click)="resetPassword(user)">
                            Reset password
                        </button>
                    </div>

                    <div class="roles-section">
                        <!-- <strong>Cambiar rol:</strong> -->
                        <button mat-stroked-button *ngFor="let r of roles" (click)="changeRole(user.uid, r)"
                            [disabled]="user.role === r">
                            {{ r }}
                        </button>
                    </div>

                </div>

            </div>
        </mat-card>
    </mat-tab>

    <!-- ================= CARD CLIENTES  ================= -->
    <mat-tab label="Clientes">
        <mat-card *ngFor="let user of getFilteredUsers(clients)" class="client-card" [attr.id]="user.uid">

            <!-- HEADER -->
            <div class="card-header aligned-top">


                <!-- FOTO -->
                <div class="avatar-wrapper" (click)="confirmChangeAdminPhoto(user, fileInput)">

                    <div class="avatar-wrapper">

                        <!-- FOTO ADMIN (principal) -->
                        <img class="avatar-admin" [src]="user.adminPhotoURL || '/images/images.png'">

                        <!-- MINI FOTO PERFIL USUARIO -->
                        <img *ngIf="user.photoURL" class="avatar-user-mini" [src]="user.photoURL">

                        <!-- SPINNER -->
                        <div class="spinner-overlay" *ngIf="uploadingPhotoUserId === user.uid">
                            <mat-spinner diameter="35"></mat-spinner>
                        </div>

                    </div>

                    <div class="spinner-overlay" *ngIf="uploadingPhotoUserId === user.uid">

                        <mat-spinner diameter="40"></mat-spinner>

                    </div>

                </div>

                <!-- INPUT OCULTO -->
                <input type="file" #fileInput hidden accept="image/*" (change)="uploadAdminPhoto(user, $event)">
                <!-- INFORMACI√ìN -->
                <div class="basic-info">

                    <h3>
                        {{ user.name }} {{ user.lastNameFather }} {{ user.lastNameMother }}

                    </h3>
                    <div class="compact-row">
                        <span *ngIf="user.email"> ‚úâÔ∏è {{ user.email }}</span>

                        <span *ngIf="user.phoneNumber">üìû {{ user.phoneNumber }}</span>
                    </div>
                    <div class="compact-row">

                        <span *ngIf="user.membershipStart">
                            Inicio:
                            {{ user.membershipStart?.toDate() | date:'mediumDate' }}
                        </span>

                        <span *ngIf="user.membershipEnd">
                            Vence:
                            {{ user.membershipEnd?.toDate() | date:'mediumDate' }}
                        </span>
                    </div>

                    <div class="compact-row">
                        <span *ngIf="user.planId">
                            üè∑ {{ getPlanName(user.planId) }}
                        </span>

                        <span *ngIf="user.lastPaymentAmount">
                            √öltimo pago: ${{ user.lastPaymentAmount }}
                        </span>
                    </div>

                    <div class="compact-row">
                        <span *ngIf="user.gender">
                            G√©nero: {{ user.gender }}
                        </span>

                        <span *ngIf="user.emergencyContact?.name || user.emergencyContact?.phone">
                            Emergencia:
                            {{ user.emergencyContact?.name }}
                            <span *ngIf="user.emergencyContact?.phone">
                                ({{ user.emergencyContact?.phone }})
                            </span>
                        </span>
                    </div>

                    <!-- ESTADOS -->
                    <div class="status-row">
                        <span class="account-status" [ngClass]="{
                                'account-active': user.status === 'active',
                                'account-blocked': user.status === 'inactive'
                              }">
                            {{ user.status === 'active'
                            ? 'Cuenta Activa'
                            : 'Cuenta Bloqueada' }}
                        </span>

                        <span class="membership-status" [ngClass]="{
                                'membership-active': user.membershipStatus === 'active',
                                'membership-expired': user.membershipStatus === 'expired',
                                'membership-none': user.membershipStatus === 'none'
                              }">
                            {{
                            user.membershipStatus === 'active' ? 'Membres√≠a Activa':
                            user.membershipStatus === 'expired'? 'Membres√≠a Vencida':
                            'Sin Membres√≠a'
                            }}
                        </span>
                    </div>

                </div>

                <!-- BOT√ìN DETALLES -->
                <button mat-stroked-button color="primary" (click)="toggleDetails(user.uid)">
                    {{ expandedUserId === user.uid ? 'Ocultar' : 'Detalles' }}
                </button>

            </div>

            <!-- PANEL EXPANDIDO -->
            <div class="details-panel" *ngIf="expandedUserId === user.uid">
                <hr>

                <!-- ================= SECCI√ìN FINANCIERA ================= -->
                <div class="section-card">

                    <h4 class="section-title">üí≥ Gesti√≥n Financiera</h4>

                    <div class="section-row">
                        <mat-form-field appearance="outline" class="section-field">
                            <mat-label>Seleccionar Plan</mat-label>
                            <mat-select [(ngModel)]="user.selectedPlan">
                                <mat-option *ngFor="let plan of plans" [value]="plan.id">
                                    {{ plan.name }} - ${{ plan.price }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <button mat-raised-button color="primary" class="section-btn" (click)="assignPlan(user)"
                            [disabled]="!user.selectedPlan">

                            {{
                            user.membershipStatus === 'active'
                            ? 'Cambiar Plan'
                            : user.planId
                            ? 'Renovar Plan'
                            : 'Asignar Plan'
                            }}

                        </button>
                    </div>

                    <div class="section-row">
                        <button mat-stroked-button color="primary" (click)="viewPayments(user)" [disabled]="false">

                            üìú Historial

                        </button>

                        <button mat-raised-button color="accent" (click)="registerPayment(user)"
                            [disabled]="!user.planId">

                            Registrar Pago

                        </button>
                    </div>

                </div>


                <!-- ================= SECCI√ìN RUTINA ================= -->
                <div class="section-card">

                    <h4 class="section-title">üí™ Gesti√≥n de Rutina</h4>

                    <div class="section-row">

                        <mat-form-field appearance="outline" class="section-field">
                            <mat-label>Seleccionar Rutina</mat-label>
                            <mat-select [(ngModel)]="user.selectedRoutine">
                                <mat-option *ngFor="let routine of routines" [value]="routine.id">
                                    {{ routine.name }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <button mat-raised-button color="primary" (click)="assignRoutine(user)">

                            {{ user.assignedRoutineId ? 'Cambiar Rutina' : 'Asignar Rutina' }}

                        </button>


                    </div>

                </div>


                <!-- ================= SECCI√ìN ADMIN ================= -->
                <div class="section-card">

                    <h4 class="section-title">‚öô Administraci√≥n</h4>

                    <div class="admin-actions">
                        <button mat-stroked-button [color]="user.status === 'inactive' ? 'primary' : 'warn'"
                            (click)="toggleStatus(user)">

                            <mat-icon>
                                {{ user.status === 'inactive' ? 'lock_open' : 'lock' }}
                            </mat-icon>

                            {{ user.status === 'inactive'
                            ? 'Desbloquear cuenta'
                            : 'Bloquear cuenta' }}

                        </button>

                        <button mat-stroked-button color="accent" (click)="forceLogout(user.uid)">
                            Forzar logout
                        </button>

                        <button mat-stroked-button (click)="resetPassword(user)">
                            Reset password
                        </button>
                    </div>

                    <div class="roles-section">
                        <!-- <strong>Cambiar rol:</strong> -->
                        <button mat-stroked-button *ngFor="let r of roles" (click)="changeRole(user.uid, r)"
                            [disabled]="user.role === r">
                            {{ r }}
                        </button>
                    </div>

                </div>

            </div>
        </mat-card>
    </mat-tab>



    <!-- ================= VISITANTES ================= -->

    <mat-tab label="Visitantes">
        <mat-card *ngFor="let user of getFilteredUsers(visitors)" class="client-card">
            <div class="card-header">
                <img class="avatar" [src]="user.photoURL || '/images/images.png'">
                <div class="basic-info">
                    <h3>{{ user.name }} {{ user.lastNameFather }} {{ user.lastNameMother }}</h3>
                    <div class="compact-row">
                        <span *ngIf="user.email"> ‚úâÔ∏è {{ user.email }}</span>
                        <span *ngIf="user.phoneNumber">üìû {{ user.phoneNumber }}</span>
                    </div>
                    <span class="account-status" [ngClass]="{
                      'status-active': user.status === 'active',
                      'status-inactive': user.status === 'inactive'
                    }">
                        {{ user.status === 'active' ? 'Cuenta Activa' : 'Cuenta Bloqueada' }}
                    </span>
                </div>
                <button mat-stroked-button color="primary" (click)="toggleDetails(user.uid)">
                    {{ expandedUserId === user.uid ? 'Ocultar' : 'Detalles' }}
                </button>
            </div>
            <div class="details-panel" *ngIf="expandedUserId === user.uid">
                <hr>
                <div class="admin-actions">
                    <button mat-stroked-button [color]="user.status === 'inactive' ? 'primary' : 'warn'"
                        (click)="toggleStatus(user)">

                        <mat-icon>
                            {{ user.status === 'inactive' ? 'lock_open' : 'lock' }}
                        </mat-icon>

                        {{ user.status === 'inactive'
                        ? 'Desbloquear cuenta'
                        : 'Bloquear cuenta' }}

                    </button>
                    <button mat-stroked-button color="accent" (click)="forceLogout(user.uid)">
                        Forzar logout
                    </button>
                    <button mat-stroked-button (click)="resetPassword(user)">
                        Reset password
                    </button>
                </div>

                <div class="roles-section">
                    <strong>Cambiar rol:</strong>
                    <button mat-stroked-button *ngFor="let r of roles" (click)="changeRole(user.uid, r)"
                        [disabled]="user.role === r">
                        {{ r }}
                    </button>
                </div>
            </div>
        </mat-card>
    </mat-tab>
</mat-tab-group>