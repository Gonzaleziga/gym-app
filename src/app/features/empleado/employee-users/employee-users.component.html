<div *ngIf="loading">
    <p>Cargando usuarios...</p>
</div>

<!-- üîç BUSCADOR GENERAL -->
<div class="search-bar">
    <input type="text" placeholder="üîç Buscar por nombre o email..." [(ngModel)]="searchTerm" />
</div>

<mat-tab-group *ngIf="!loading" [(selectedIndex)]="activeTabIndex">

    <!-- ================= CLIENTES ================= -->
    <mat-tab label="Clientes">

        <mat-card *ngFor="let user of getFilteredUsers(clients)" class="client-card">

            <!-- HEADER -->
            <div class="card-header aligned-top">

                <!-- FOTO -->
                <img class="avatar-admin" [src]="user.photoURL || '/images/images.png'">

                <!-- INFORMACI√ìN -->
                <div class="basic-info">

                    <h3>
                        {{ user.name }}
                        {{ user.lastNameFather }}
                        {{ user.lastNameMother }}
                    </h3>

                    <div class="compact-row">
                        <span *ngIf="user.email"> ‚úâÔ∏è {{ user.email }}</span>
                        <span *ngIf="user.phoneNumber">üìû {{ user.phoneNumber }}</span>
                    </div>

                    <div class="compact-row">
                        <span *ngIf="user.membershipStart">
                            Inicio:
                            {{ user.membershipStart?.toDate() | date:'mediumDate' }}
                        </span>

                        <span *ngIf="user.membershipEnd">
                            Vence:
                            {{ user.membershipEnd?.toDate() | date:'mediumDate' }}
                        </span>
                    </div>

                    <div class="compact-row">
                        <span *ngIf="user.planId">
                            Plan: {{ getPlanName(user.planId) }}
                        </span>

                        <span *ngIf="user.lastPaymentAmount">
                            √öltimo pago: ${{ user.lastPaymentAmount }}
                        </span>
                    </div>

                    <!-- ESTADO MEMBRES√çA -->
                    <div class="status-row">
                        <span class="membership-status" [ngClass]="{
                  'membership-active': user.membershipStatus === 'active',
                  'membership-expired': user.membershipStatus === 'expired',
                  'membership-none': user.membershipStatus === 'none'
                }">

                            {{
                            user.membershipStatus === 'active'
                            ? 'Membres√≠a Activa'
                            : user.membershipStatus === 'expired'
                            ? 'Membres√≠a Vencida'
                            : 'Sin Membres√≠a'
                            }}

                        </span>
                    </div>

                </div>

                <!-- BOT√ìN DETALLES -->
                <button mat-stroked-button color="primary" (click)="toggleDetails(user.uid)">
                    {{ expandedUserId === user.uid ? 'Ocultar' : 'Detalles' }}
                </button>

            </div>

            <!-- ================= PANEL EXPANDIDO ================= -->
            <div class="details-panel" *ngIf="expandedUserId === user.uid">

                <hr>

                <!-- ================= SECCI√ìN FINANCIERA ================= -->
                <div class="section-card">

                    <h4 class="section-title">üí≥ Gesti√≥n Financiera</h4>

                    <div class="section-row">

                        <mat-form-field appearance="outline" class="section-field">
                            <mat-label>Seleccionar Plan</mat-label>
                            <mat-select [(ngModel)]="user.selectedPlan">
                                <mat-option *ngFor="let plan of plans" [value]="plan.id">
                                    {{ plan.name }} - ${{ plan.price }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <button mat-raised-button color="primary" (click)="assignPlan(user)"
                            [disabled]="!user.selectedPlan">

                            {{
                            user.membershipStatus === 'active'
                            ? 'Cambiar Plan'
                            : user.planId
                            ? 'Renovar Plan'
                            : 'Asignar Plan'
                            }}

                        </button>

                    </div>

                    <div class="section-row">

                        <button mat-stroked-button color="primary" (click)="viewPayments(user)">
                            üìú Historial
                        </button>

                        <button mat-raised-button color="accent" (click)="registerPayment(user)"
                            [disabled]="!user.planId">
                            Registrar Pago
                        </button>

                    </div>

                </div>

                <!-- ================= SECCI√ìN RUTINA ================= -->
                <div class="section-card">

                    <h4 class="section-title">üí™ Gesti√≥n de Rutina</h4>

                    <div class="section-row">

                        <mat-form-field appearance="outline" class="section-field">
                            <mat-label>Seleccionar Rutina</mat-label>
                            <mat-select [(ngModel)]="user.selectedRoutine">
                                <mat-option *ngFor="let routine of routines" [value]="routine.id">
                                    {{ routine.name }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <button mat-raised-button color="primary" (click)="assignRoutine(user)">
                            {{ user.assignedRoutineId
                            ? 'Cambiar Rutina'
                            : 'Asignar Rutina' }}
                        </button>

                    </div>

                </div>

            </div>

        </mat-card>

    </mat-tab>

    <!-- ================= VISITANTES ================= -->
    <mat-tab label="Visitantes">

        <mat-card *ngFor="let user of getFilteredUsers(visitors)" class="client-card">

            <div class="card-header">

                <img class="avatar" [src]="user.photoURL || '/images/images.png'">

                <div class="basic-info">

                    <h3>
                        {{ user.name }}
                        {{ user.lastNameFather }}
                        {{ user.lastNameMother }}
                    </h3>

                    <div class="compact-row">
                        <span *ngIf="user.email"> ‚úâÔ∏è {{ user.email }}</span>
                        <span *ngIf="user.phoneNumber">üìû {{ user.phoneNumber }}</span>
                    </div>

                </div>

                <button mat-raised-button color="primary" (click)="convertToClient(user)">
                    üîÑ Convertir a Cliente
                </button>

            </div>

        </mat-card>

    </mat-tab>

</mat-tab-group>