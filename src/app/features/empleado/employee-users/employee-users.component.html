<div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Cargando usuarios...</p>
</div>

<!-- ğŸ” BUSCADOR -->
<div class="search-bar">
    <input type="text" placeholder="ğŸ” Buscar por nombre o email..." [(ngModel)]="searchTerm" />
</div>

<mat-tab-group *ngIf="!loading" [(selectedIndex)]="activeTabIndex">

    <!-- ================= CLIENTES ================= -->
    <mat-tab label="Clientes">

        <mat-card *ngFor="let user of getFilteredUsers(clients)" class="client-card">

            <!-- HEADER -->
            <div class="card-header">

                <!-- AVATAR -->
                <div class="avatar-wrapper" (click)="confirmChangeAdminPhoto(user, fileInput)">

                    <img class="avatar-admin" [src]="user.adminPhotoURL || '/images/images.png'">

                    <div class="spinner-overlay" *ngIf="uploadingPhotoUserId === user.uid">
                        <mat-spinner diameter="35"></mat-spinner>
                    </div>

                    <input type="file" #fileInput hidden accept="image/*" (click)="$event.stopPropagation()"
                        (change)="uploadAdminPhoto(user, $event)">
                </div>

                <!-- INFO -->
                <div class="basic-info">

                    <h3>
                        {{ user.name }}
                        {{ user.lastNameFather }}
                        {{ user.lastNameMother }}
                    </h3>

                    <div class="compact-row">
                        <span *ngIf="user.email"> âœ‰ï¸ {{ user.email }}</span>
                        <span *ngIf="user.phoneNumber">ğŸ“ {{ user.phoneNumber }}</span>
                    </div>

                    <div class="compact-row">
                        <span *ngIf="user.membershipStart">
                            Inicio:
                            {{ user.membershipStart?.toDate() | date:'mediumDate' }}
                        </span>

                        <span *ngIf="user.membershipEnd">
                            Vence:
                            {{ user.membershipEnd?.toDate() | date:'mediumDate' }}
                        </span>
                    </div>

                    <div class="compact-row">
                        <span *ngIf="user.planId" class="plan-badge">
                            ğŸ· {{ getPlanName(user.planId) }}
                        </span>

                        <span *ngIf="user.lastPaymentAmount">
                            Ãšltimo pago: ${{ user.lastPaymentAmount }}
                        </span>

                        <!-- <span *ngIf="user.assignedRoutineId" class="routine-badge">
                            ğŸ’ª Rutina asignada
                        </span> -->
                    </div>

                    <div class="compact-row">
                        <span *ngIf="user.gender">
                            GÃ©nero: {{ user.gender }}
                        </span>

                        <span *ngIf="user.emergencyContact?.name || user.emergencyContact?.phone">
                            Emergencia:
                            {{ user.emergencyContact?.name }}
                            <span *ngIf="user.emergencyContact?.phone">
                                ({{ user.emergencyContact?.phone }})
                            </span>
                        </span>
                    </div>

                    <!-- ESTADO MEMBRESÃA -->
                    <div class="status-row">
                        <span class="membership-status" [ngClass]="{
                      'membership-active': user.membershipStatus === 'active',
                      'membership-expired': user.membershipStatus === 'expired',
                      'membership-none': user.membershipStatus === 'none'
                    }">

                            {{
                            user.membershipStatus === 'active'
                            ? 'MembresÃ­a Activa'
                            : user.membershipStatus === 'expired'
                            ? 'MembresÃ­a Vencida'
                            : 'Sin MembresÃ­a'
                            }}

                        </span>
                    </div>

                </div>

                <!-- BOTÃ“N DETALLES -->
                <button mat-stroked-button color="primary" (click)="toggleDetails(user.uid)">
                    {{ expandedUserId === user.uid ? 'Ocultar' : 'Detalles' }}
                </button>

            </div>

            <!-- ================= PANEL EXPANDIDO ================= -->
            <div class="details-panel" *ngIf="expandedUserId === user.uid">

                <hr>

                <!-- ================= SECCIÃ“N FINANCIERA ================= -->
                <div class="section-card">

                    <h4 class="section-title">ğŸ’³ GestiÃ³n Financiera</h4>

                    <div class="section-row">

                        <mat-form-field appearance="outline" class="section-field">
                            <mat-label>Seleccionar Plan</mat-label>
                            <mat-select [(ngModel)]="user.selectedPlan">
                                <mat-option *ngFor="let plan of plans" [value]="plan.id">
                                    {{ plan.name }} - ${{ plan.price }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <button mat-raised-button color="primary" (click)="assignPlan(user)"
                            [disabled]="!user.selectedPlan">

                            {{
                            user.membershipStatus === 'active'
                            ? 'Cambiar Plan'
                            : user.planId
                            ? 'Renovar Plan'
                            : 'Asignar Plan'
                            }}

                        </button>

                    </div>

                    <div class="section-row buttons-row">

                        <button mat-stroked-button color="primary" (click)="viewPayments(user)">
                            ğŸ“œ Historial
                        </button>

                        <button mat-raised-button color="accent" (click)="registerPayment(user)"
                            [disabled]="!user.planId">
                            ğŸ’µ Registrar Pago
                        </button>

                    </div>

                </div>

                <!-- ================= SECCIÃ“N RUTINA ================= -->
                <div class="section-card">

                    <h4 class="section-title">ğŸ’ª GestiÃ³n de Rutina</h4>

                    <div class="section-row">

                        <mat-form-field appearance="outline" class="section-field">
                            <mat-label>Seleccionar Rutina</mat-label>

                            <mat-select [(ngModel)]="user.selectedRoutine">
                                <mat-option *ngFor="let routine of routines" [value]="routine.id">
                                    {{ routine.name }}
                                </mat-option>
                            </mat-select>

                        </mat-form-field>

                        <button mat-raised-button color="primary" (click)="assignRoutine(user)"
                            [disabled]="!user.selectedRoutine">

                            {{ user.assignedRoutineId
                            ? 'Cambiar Rutina'
                            : 'Asignar Rutina' }}

                        </button>

                    </div>

                </div>

            </div>

        </mat-card>

    </mat-tab>

    <!-- ================= VISITANTES ================= -->
    <mat-tab label="Visitantes">

        <mat-card *ngFor="let user of getFilteredUsers(visitors)" class="client-card">

            <div class="card-header">

                <div class="avatar-wrapper">
                    <img class="avatar-admin" [src]="user.photoURL || '/images/images.png'">
                </div>

                <div class="basic-info">

                    <h3>
                        {{ user.name }}
                        {{ user.lastNameFather }}
                        {{ user.lastNameMother }}
                    </h3>

                    <div class="compact-row">
                        <span *ngIf="user.email"> âœ‰ï¸ {{ user.email }}</span>
                        <span *ngIf="user.phoneNumber">ğŸ“ {{ user.phoneNumber }}</span>
                    </div>

                </div>

                <button mat-raised-button color="primary" (click)="convertToClient(user)">
                    ğŸ”„ Convertir a Cliente
                </button>

            </div>

        </mat-card>

    </mat-tab>

</mat-tab-group>